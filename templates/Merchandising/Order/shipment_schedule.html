{% extends "index.html" %}
{% load static %}
{% load widget_tweaks %}
{% load mathfilters %}
{% block title %} Lakshma | Shipment Schedule {% endblock title %}
{% block homeactive  %}active{% endblock homeactive  %}

{% block css %}
<style>

tfoot {
     display: table-header-group;
}

</style>
{% endblock css %}

{% block body %}
<div id="loading" class="text-center">
  <figure>
    <img class="loading-image" height="100px" src="{% static 'icon/covid.gif' %}">
    <h5> <figcaption class="text-center text-danger loading-image font-weight-bolder">Please Wait,Your Content is Loading....</figcaption></h5>
  </figure>
</div>

<div class="container-fluid search-box">
  <div class="text-center mt-2 font-weight-bold"><h5>Shipment Schedule</h5></div>
    <div class="card mt-2">
      <div class=" search mt-1 text-center">
        <form method="GET" class="ml-2 mr-2" action="{% url 'shipment_schedule' %}">
          <table  class="table table-sm table-bordered table-responsive table-responsive-sm tabel-hover  ">
            <thead class="bg-meroon">
              <tr>
                <th width="150px;">Company</th>
                <th >Location</th>
                <th >Buyer</th>
                <th >Agent </th>
                <th >Style</th>
                <th >Job No.</th>
                <th >Order No.</th>
                <th >Team</th>
                <th >Dealing Merchant</th>
                <th >Factory Merchant</th>
                <th >Product Category</th>
                <th >Start Date</th>
                <th >End Date</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  {{ myFilter.form.company_name|attr:"class:form-controls"}}
                </td>
                <td>
                  {{ myFilter.form.company_location|attr:"class:form-controls"}}
                </td>
            
                <td>
                  {{ myFilter.form.buyer_name|attr:"class:form-controls"}}
                </td>
                <td>{{ myFilter.form.agent|attr:"class:form-controls"}}</td>
                <td>{{ myFilter.form.style_description|attr:"class:form-controls"}}</td>
                <td>{{ myFilter.form.job_no|attr:"class:form-controls"}}</td>
                <td>{{ myFilter.form.po_no|attr:"class:form-controls"}}</td>
              
                <td>
                  {{ myFilter.form.team_leader|attr:"class:form-controls"}}
                </td>
                <td>
                  {{ myFilter.form.dealing_merchant|attr:"class:form-controls"}}
                </td>
                <td>
                  {{ myFilter.form.factory_merchant|attr:"class:form-controls"}}
                </td>
                <td>
                  {{ myFilter.form.product_cate|attr:"class:form-controls"}}
                </td>
        
                <td>
                
                  {{ myFilter.form.start_date|attr:"type:date"|attr:"class:form-control"|attr:"id:start_date"  }}
                </td>
                  <td>
                    {{ myFilter.form.end_date|attr:"type:date"|attr:"class:form-control"|attr:"id:end_date"  }}
                  </td>
              </tr>
            </tbody>
          </table>
          <div class="container justify-content-center align-content-center text-center ">
            <button type="submit" class="btn btn-sm btn-success"><i class="fa fa-search mr-2" aria-hidden="true"></i>Search</button>
            <a href="{% url 'shipment_schedule' %}" type="button" class="btn btn-sm btn-danger "><i class="fa fa-times" aria-hidden="true"></i> Reset</a>
          </div>
        </form>
        <div class="container ">
          <div class="d-flex justify-content-center table-responsive">
            <div class="p-1">
              <table class="mb-1 table-sm  table-responsive-sm ">
                <thead>
                    <td width="20%">
                      <select id="getYear" onChange="copyTextValue()" class="form-control">
                        <option value="" disabled selected>Select</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                      </select>
                    </td>
                    <td><button type="" class="btn btn-sm btn-info ml-2 " >Jan</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Feb</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Mar</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Apr</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">May</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Jun</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Jul</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Aug</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Sep</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Oct</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2" onclick="myFunction()"  id="getMonth">Nov</button></td>
                    <td><button type="" class="btn btn-sm btn-info ml-2">Dec</button></td>
                </thead>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>


  {% if  '/merchandise/shipment_schedule/?' in request.get_full_path %}
  <div class="container-fluid " >
    <div class="d-flex justify-content-center">
      <div class="p-1 has-search">
        <span class="fa fa-search form-control-feedback"></span>
        <input name="min" id="min" class="form-control" type="text" placeholder="Pub. Ship. Start Date"  > 
      </div>
      <div class="p-1 has-search">
        <span class="fa fa-search form-control-feedback"></span>
        <input name="max" id="max" class="form-control" type="text" placeholder="Pub. Ship. End Date"  >
      </div>
    </div>
    <table id="shipment_report" name="schedule" class="table table-bordered table-striped table-sm table-responsive-sm table-hover table-info display text-center">
      <thead class="fixed-header bg-info">
          <tr>
              <th class="text-left text-uppercase bg-info" colspan="53">
                  <h6 >Report Panel</h6>
              </th>
          </tr>
        <tr>
          <th >SL.</th>
          <th>Company Name</th>
          <th>Job No</th>
          <th>Buyer</th>
          <th >Agent</th>
          <th >Order No</th>
          <th >Season</th>
          <th >Prod. Dept</th>
          <th>Sub. Dept</th>
          <th>Sub. Dept Code</th>
          <th>Image </th>
          <th>File</th>
          <th>Item</th>
          <th>Style Ref. </th>
          <th>Style Des </th>
          <th> Country </th>
          <th> Po Insert Date </th>
          <th> Pub Ship Date </th>
          <th> Fac Receive Date </th>
          <th> Lead Time </th>
          <th> SMV </th>
          <th> Total SMV </th>
          <th> Order Qnty </th>
          <th> Uom </th>
          <th> Order Qnty(Pcs) </th>
          <th> Eqv. Basic Qty(Pcs) </th>
          <th> Per Unit Price </th>
          <th> Order Value </th>
          <th> Commission </th>
          <th> Net Order Value </th>
          <th> Ex.Fac Qnty(Pcs) </th>
          <th> Ex.Fac Value </th>
          <th> Ex.Fac Bal(Pcs) </th>
          <th> Ex.Fac Bal. Value </th>
          <th> Ex.Fac Over(Pcs) </th>
          <th> Ex.Fac Over Value </th>
          <th> Short/Over/At Per </th>
          <th> Order Status </th>
          <th> Prod Catg </th>
          <th> PO Rec Date </th>
          <th> Days In Hand</th>
          <th> Shipping Status</th>
          <th> Dealing Merchant</th>
          <th> Factory Merchant</th>
          <th> Team Name</th>
          <th> Ship Mode</th>
          <th> Internal Ref Grouping</th>
          <th> File No</th>
          <th> Inserted By</th>
          <th> Pre-Cost Id</th>
          <th> Delay Reason</th>
          <th> Reamrks</th>
        </tr>
         
      </thead>
      <tfoot id="tfooter">
        <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
      </tfoot>
      <tbody >
        {% for i in orders %}
          {% for p in i.order_entry.all %}
           
        <tr>
  
          <!-- <td>{{forloop.counter}}</td> -->
          <td></td>
          <td>{{i.company_name}}</td>
          <td>{{i.job_no}}</td>
          <td>{{i.buyer_name}}</td>
          <td>{{i.agent}}</td>
          <td ><a href="{% url 'work_progress' p.id %}"> {{p.po_no}}</a></td>
          <td >{{i.season}}</td>
          <td >{{i.product_dept}}</td>
          <td >{{i.sub_dept}}</td>
          <td >{{i.sub_dept_code}}</td>
          <td >
            {% if i.image %}
         	<a href="{{i.image.url}}"  data-gall="portfolioGallery" class="venobox" title="">
              <img height="30px" width="30px" src="{{i.image.url}}">
            </a>
            {% endif %}
          </td>
          
          <td>
            {% if i.file %}
            <a href="{{i.file.url}}">File</a>
            {% endif %}
           </td>
          <td>
            {% for item in p.color_size.all|slice:":1" %}
            {{item.gmt_items}}
            {% endfor %}
          </td>
          <td>{{i.style_ref}}</td>
          <td>{{i.style_description}}</td>
          <td >{{p.country}}</td>
          <td>{{p.insert_date}}</td>
          <td class="pub_date">{{p.pub_shipment_date}}</td>
          <td>{{p.fac_recieve_date}}</td>
          <td>{{p.lead_time}}</td>
          <td class="tsmv sv">{{i.smv|floatformat:2}}</td>
          <td id="totalSmv"></td>
          <td class="oq tsmv oqb eqhidesmv">{{p.po_quantity}}</td>
          <td>{{i.order_uom}}</td>
          <td >{{p.po_quantity}}</td>
          <td >{{i.smv|div:4|mul:p.po_quantity|floatformat:2}}</td>
          <td class="oq">{{p.avg_price|floatformat:2}}</td>
          <td id="order_value"></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>{{p.order_status}}</td>
          <td>{{i.product_cate}}</td>
          <td >{{p.po_recieve_date}}</td>
          <td id="lead_date"></td>
          <td></td>
          <td>{{i.dealing_merchant}}</td>
          <td>{{i.factory_merchant}}</td>
          <td>{{i.team_leader}}</td>
          <td>{{i.ship_mode}}</td>
          <td>{{p.internal_ref}}</td>
          <td>{{p.file_no}}</td>
          <td>{{i.inserted_by.full_name}}</td>
          <td></td>
          <td>{{p.delay_for}}</td>
          <td>{{p.remarks}}</td>
          
        </tr>
              
           {% endfor %}
        {% endfor %}
      </tbody>
      <tfoot>
        <th colspan="20" class="text-right font-weight-bold">Total: </th>
        <th id="rp_tAvg_smv" class="bg-yel"></th>
        <th id="rp_tt_smv" class="bg-yel"></th>
        <th id="rp_tt_ord" class="bg-yel"></th>
        <th ></th>
        <th id="rp_tt_ordq" class="bg-yel"></th>
        <th id="rp_tt_eqv" class="bg-yel"></th>
        <th id="rp_tt_up" class="bg-yel">0</th>
        <th id="rp_tt_ov" class="bg-yel">0</th>
        <th class="bg-yel">0</th>
        <th colspan="23"></th>
      </tfoot>
      
      
    </table>
  </div>
  {% endif %}


{% endblock body %}

{% block script %}
<script>
    // FOR SHOWING THE TODAY DATE 
    var today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1; //January is 0!
    var yyyy = today.getFullYear();
    if(dd<10) {
        dd = '0'+dd
      } 
    if(mm<10) {
        mm = '0'+mm
      } 
    // today = yyyy + '/' + mm + '/' + dd;
    today = yyyy + '-' + mm + '-' + dd;
    console.log(today);
    document.getElementById('invoice_date').innerHTML = today;
</script>

<script>
    $(document).ready(function() {
      $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
            var min = $('#min').datepicker("getDate");
            var max = $('#max').datepicker("getDate");
            var startDate = new Date(data[17]);
            if (min == null && max == null) { return true; }
            if (min == null && startDate <= max) { return true;}
            if(max == null && startDate >= min) {return true;}
            if (startDate <= max && startDate >= min) { return true; }
            return false;
        }
        );

       
      $("#min").datepicker({ onSelect: function () { table.draw(); }, changeMonth: true, changeYear: true });
      $("#max").datepicker({ onSelect: function () { table.draw(); }, changeMonth: true, changeYear: true });
           
      // Setup - add a text input to each footer cell
      $('#shipment_report #tfooter th').each( function () {
          var title = $(this).text();
          $(this).html( '<input type="text" class="form-controls" placeholder="Search" />' );
      });

      // CALCULATION FOR REPORT PANEL (ORDER VALUE) ===--->
      // FOR MULTIPLICATION ORDERVALUE STARTS FROM 1
      $('tr').each(function(){
        var orderValue = 1;
        $(this).find('.oq').each(function(){
          var allquan_per = $(this).text();
          if(allquan_per.length!==0)
          {
            orderValue *=  parseFloat(allquan_per);
	    orderValue = orderValue.toFixed(2);
          }
        });
        $(this).find('#order_value').html(orderValue);
      });
      
      // CALCULATION FOR REPORT PANEL (TOTAL SMV VALUE) ===--->
      $('tr').each(function(){
        var totSmv = 1;
        $(this).find('.tsmv').each(function(){
          var allquan_per = $(this).text();
          if(allquan_per.length!==0)
          {
            totSmv *=  parseFloat(allquan_per);
	    totSmv = totSmv.toFixed(2)
          }
        });
        $(this).find('#totalSmv').html(totSmv);
      });
      // CALCULATION FOR REPORT PANEL (DAYS IN HAND VALUE) ===--->
      $('tr').each(function(){
        var dayesInHand = 0;
        $(this).find('.pub_date').each(function(){
          var pubDate = $(this).text();
          pubDate = new Date(pubDate);
          var present_date = new Date();
          var pred = present_date.getTime();
          var pubd = pubDate.getTime();
          if(pubDate.length!==0)
          {
            dit =  pred - pubd;
            dayesInHand = (dit / (1000 * 3600 *24)).toFixed(0);
          }
        });
        $(this).find('#lead_date').html(dayesInHand);
      });

      // CALCULATION FOR REPORT PANEL (HIDDEN SMV VALUE) ===--->
      // HIDDEN FIELD FOR EQUIVALENT BASIC
      $('tr').each(function(){
        var finalsmv = 1;
        $(this).find('.sv').each(function(){
          var smv = $(this).text();
          if(smv.length!==0)
          {
            // EQUIVALENT BASIC CONFIRMED DIVISION NUMBER IS 4
            finalsmv = parseFloat(smv / 4) ;
          }
        });
        $(this).find('#hiddensmv').html(finalsmv);
      });

      $('tr').each(function(){
        var eqvb = 1;
        $(this).find('.eqhidesmv').each(function(){
          var hidesmv = $(this).text();
          if(hidesmv.length!==0)
          {
            eqvb *= parseFloat(hidesmv);
          }
        });
        $(this).find('#eqvbasic').html(eqvb);
      });

      // DataTable
      var table = $('#shipment_report').DataTable({
        drawCallback: function(){
          const rp_tAvg_smv = this.api().column(20,{search:'applied'}).data().toArray().reduce((total,rp_tAvg_smv) => total+=Number(rp_tAvg_smv.replace(/[^0-9\.]/g,'')),0).toFixed(2);
          $('#rp_tAvg_smv').text(` ${(rp_tAvg_smv)}`);

          //const rp_tAvg_smv = this.api().column(21,{search:'applied'}).data().toArray().reduce((total,rp_tAvg_smv) => total+=Number(rp_tAvg_smv.replace(/[^0-9\.]/g,'')),0);
          //$('#rp_tAvg_smv').text(` ${(rp_tAvg_smv)}`);
          
          const rp_tt_smv = this.api().column(21,{search:'applied'}).data().toArray().reduce((total,rp_tt_smv) => total+=Number(rp_tt_smv.replace(/[^0-9\.]/g,'')),0).toFixed(2);
          $('#rp_tt_smv').text(` ${(rp_tt_smv)}`);
  
          const rp_tt_ord = this.api().column(22,{search:'applied'}).data().toArray().reduce((total,rp_tt_ord) => total+=Number(rp_tt_ord.replace(/[^0-9\.]/g,'')),0).toFixed(2);
          $('#rp_tt_ord').text(` ${(rp_tt_ord)}`);
  
          const rp_tt_ordq = this.api().column(24,{search:'applied'}).data().toArray().reduce((total,rp_tt_ordq) => total+=Number(rp_tt_ordq.replace(/[^0-9\.]/g,'')),0).toFixed(2);
          $('#rp_tt_ordq').text(` ${(rp_tt_ordq)}`);
  
          const rp_tt_eqv = this.api().column(25,{search:'applied'}).data().toArray().reduce((total,rp_tt_eqv) => total+=Number(rp_tt_eqv.replace(/[^0-9\.]/g,'')),0).toFixed(2);
          $('#rp_tt_eqv').text(` ${(rp_tt_eqv)}`);
  
          const rp_tt_up = this.api().column(26,{search:'applied'}).data().toArray().reduce((total,rp_tt_up) => total+=Number(rp_tt_up.replace(/[^0-9\.]/g,'')),0).toFixed(2);
          $('#rp_tt_up').text(` ${(rp_tt_up)}`);
  
          const rp_tt_ov = this.api().column(27,{search:'applied'}).data().toArray().reduce((total,rp_tt_ov) => total+=Number(rp_tt_ov.replace(/[^0-9\.]/g,'')),0).toFixed(2);
          $('#rp_tt_ov').text(` ${(rp_tt_ov)}`);
  
        },
      dom: 'Bfrtip',
      buttons: [
        {
            extend: 'copyHtml5',
            exportOptions: {
              columns: ':visible'
            }
        },
        {
            extend: 'excelHtml5',
            exportOptions: {
              columns: ':visible'
            }
        },
        {
            extend: 'csvHtml5',
            exportOptions: {
              columns: ':visible'
            }
        },
        
        'colvis'
      ],
      "bPaginate": false,
      "scrollY": 470,
      "scrollX": true,
      columnDefs: [ { type: 'date', 'targets': [17] } ],
      order: [[ 17, 'asc' ]],
          initComplete: function () {
              // Apply the search
              this.api().columns().every( function () {
                  var that = this;
   
                  $( 'input', this.footer() ).on( 'keyup change clear', function () {
                      if ( that.search() !== this.value ) {
                          that
                              .search( this.value )
                              .draw();
                      }
                  } );
              } );
          }
      });

      // Event listener to the two range filtering inputs to redraw on input
      $('#min, #max').change(function () {
        table.draw();
    });
      // FOR GENERATING SERIAL NUMBER
      table.on( 'order.dt search.dt', function () {
        table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
            cell.innerHTML = i+1;
        } );
    } ).draw();
  } );
</script>


{% endblock script %}

